---
title: "Liver Disease Prediction"
author: "Lorenzo Baietti, Francesco Carlesso, Matteo Mazzini"
date: "A.Y. 2023/2024"
font: 11pt
output:
  pdf_document:
    toc: true
    # number_sections: true
  html_document:
    toc: true
    # number_sections: true
---

## 1. Project Introduction and Dataset Description

Liver Diseases can be caused by different kind of factors such as viruses, genetics, excessive alcohol consumption, drug usage, obesity, etc. Early diagnosis is crucial for carrying out a successful treatment, therefore we decided perform an analysis to understand which are the most influential biochemical markers that define this condition, focusing on a binary classification task which uses parameters that can be obtained simply by performing blood tests. The dataset we are going to analyze and use for our task is the [Indian Liver Patient Dataset (ILPD)](https://archive.ics.uci.edu/ml/datasets/ILPD+(Indian+Liver+Patient+Dataset)) present in the UCI Machine Learning Repository. This dataset contains 583 patient records, split between 441 males and 142 females, and described by 10 variables plus a binary target for the diagnosis. Out of all the patients, 416 have a positive diagnosis.

## 2. Data Preprocessing

First, we import all the necessary packages to manipulate the data, then we load the dataset assigning the correct column names to it.

```{r include=FALSE}
library(corrplot)
library(car)
library(pROC)
library(e1071)
library(class)
library(boot)
library(leaps)
library(glmnet)
```

```{r}
c_names <- c('Age', 'Gender','TB','DB','Alkphos','Sgpt','Sgot','TP','ALB','AG_ratio','Response')

data <- read.csv('Indian Liver Patient Dataset (ILPD).csv', col.names = c_names, header = FALSE)
```

Since there is a preprocessing operation declared in the dataset information, that is: *Any patient whose age exceeded 89 is listed as being of age "90"*, we check how many patients are listed to be 90 years old, and we find that there is only one. We conjecture that this transformation is therefore understandable, and necessary to avoid creating non-significant outliers, also, given that this represents a very small proportion of the data, we accept it as it is.

```{r}
age_count_90 <- sum(data$Age == 90)
age_count_90
```

We then transform the response variable into a binary one, where '1' indicates the presence of liver disease and '0' the absence, given that in the original dataset the latter is marked with '2'.

```{r}
data$Response[data$Response == 2] <- 0

#check the structure of the data
str(data)
```

By checking the structure of the data we notice that we need to transform the `Gender` and `Response` variables into factors.

```{r}
data$Gender <- as.factor(data$Gender)
data$Response <- as.factor(data$Response)

summary(data)
```

As can be already understood from the description of the dataset, also from looking at the summary it is clear that the distribution of the response variable is pretty unbalanced. Furthermore, we can see that there are 4 NA values in the `AG_ratio` variable, and thus we decide to replace them with the median of the column since this measure is less sensible to extreme points.

```{r}
data$AG_ratio[is.na(data$AG_ratio)]<- median(data$AG_ratio, na.rm = TRUE)
any(is.na(data))
```

| Variable | Description                                                       |
|:-------------------------|:---------------------------------------------|
| Age      | Age of the patient                                                |
| Gender   | Gender of the patient                                             |
| TB       | Total Bilirubin in milligrams per deciliter (mg/dL)               |
| DB       | Direct Bilirubin in milligrams per deciliter (mg/dL)              |
| Alkphos  | Alkaline Phosphotase in units per Liter (U/L)                     |
| Sgpt     | Alanine Aminotransferase in units per Liter (U/L)                 |
| Sgot     | Aspartate Aminotransferase in units per Liter (U/L)               |
| TP       | Total Proteins in grams per deciliter (g/dL)                      |
| ALB      | Albumin in grams per deciliter (g/dL)                             |
| AG_ratio | Albumin vs. Globulin ratio                                        |
| Response | '1' if the patient is diagnosed with Liver Disease, '0' otherwise |

Given that the data is pretty unbalanced with respect to the response variable, we decide to perform stratified sampling when doing the train-test split, in order to respect the proportion of the response variable values in both sets, thus trying to avoid biased results. We choose a 0.75 train and 0.25 test split.

```{r}
#train-test splitting

train_proportion <- 0.75
train_set <- data.frame()
test_set <- data.frame()
for (level in unique(data$Response)) {
  subset_data <- data[data$Response == level, ]
  train_size <- round(nrow(subset_data) * train_proportion)
  train_indices <- sample(1:nrow(subset_data), train_size)
  train_subset <- subset_data[train_indices, ]
  test_subset <- subset_data[-train_indices, ]
  train_set <- rbind(train_set, train_subset)
  test_set <- rbind(test_set, test_subset)
}

#check proportion
train_prop <- round(prop.table(table(train_set$Response)),3)
test_prop <- round(prop.table(table(test_set$Response)),3)
data_prop <- round(prop.table(table(data$Response)),3)
cat('data: ',data_prop,'train: ',train_prop,'test: ',test_prop)
```

## 3. Data Exploration

### 3.1 Univariate Analysis

We perform a univariate analysis on our variables to get a sense of their distributions and characteristics. Given the constraints on the report's length we do not provide the plots for each variable but just the more distinctive ones, in any case, the script with comments is provided below and should be sufficient to understand the analysis when coupled with the few plots given.

```{r}
#Response
barplot(table(data$Response),
        main = "Response frequency",
        xlab = "Response",
        ylab = "Frequency",
        col = c("skyblue", "salmon"),
        ylim = c(0, max(table(data$Response)) + 1))
#response variable quite unbalanced as seen before

#Gender
barplot(table(data$Gender),
        main = "Gender Bar Plot",
        xlab = "Category",
        ylab = "Frequency",
        col = c("skyblue", "salmon", "lightgreen"))
#gender variable also very unbalanced

#Age
par(mfrow = c(1, 2))
boxplot(data$Age,
        main = "Age Boxplot",
        ylab = "Age",
        col = "lightblue")
hist(data$Age,
     main = "Age Histogram",
     xlab = "Values",
     col = "lightblue",
     border = "black")
par(mfrow = c(1, 1))
qqnorm(data$Age)
qqline(data$Age, col = "red", lwd = 2)
#age variable seems to be quite symmetric and normally distributed

#TB
par(mfrow = c(1, 2))
boxplot(data$TB,
        main = "TB Boxplot",
        ylab = "TB",
        col = "lightblue")
hist(data$TB,
     main = "TB Histogram",
     xlab = "Values",
     col = "lightblue",
     border = "black")

#DB
par(mfrow = c(1, 2))
boxplot(data$DB,
        main = "DB Boxplot",
        ylab = "DB",
        col = "lightblue")
hist(data$DB,
     main = "DB Histogram",
     xlab = "Values",
     col = "lightblue",
     border = "black")

#Alkphos
par(mfrow = c(1, 2))
boxplot(data$Alkphos,
        main = "Alkphos Boxplot",
        ylab = "Alkphos",
        col = "lightblue")
hist(data$Alkphos,
     main = "Alkphos Histogram",
     xlab = "Values",
     col = "lightblue",
     border = "black")

#Sgpt
par(mfrow = c(1, 2))
boxplot(data$Sgpt,
        main = "Sgpt Boxplot",
        ylab = "Sgpt",
        col = "lightblue")
hist(data$Sgpt,
     main = "Sgpt Histogram",
     xlab = "Values",
     col = "lightblue",
     border = "black")

#Sgot
par(mfrow = c(1, 2))
boxplot(data$Sgot,
        main = "Sgot Boxplot",
        ylab = "Sgot",
        col = "lightblue")
hist(data$Sgot,
     main = "Sgot Histogram",
     xlab = "Values",
     col = "lightblue",
     border = "black")

#TP
par(mfrow = c(1, 2))
boxplot(data$TP,
        main = "TP Boxplot",
        ylab = "TP",
        col = "lightblue")
hist(data$Sgpt,
     main = "TP Histogram",
     xlab = "Values",
     col = "lightblue",
     border = "black")

#ALB
par(mfrow = c(1, 2))
boxplot(data$ALB,
         main = "ALB Boxplot",
         ylab = "ALB",
         col = "lightblue")
hist(data$ALB,
     main = "ALB Histogram",
     xlab = "Values",
     col = "lightblue",
     border = "black")
par(mfrow = c(1, 1))
qqnorm(data$ALB)
qqline(data$ALB, col = "red", lwd = 2)
#ALB seems to be quite symmetric and normally distributed

#AG_ratio
par(mfrow = c(1, 2))
boxplot(data$AG_ratio,
        main = "AG_ratio Boxplot",
        ylab = "AG_ratio",
        col = "lightblue")
hist(data$AG_ratio,
     main = "AG_ratio Histogram",
     xlab = "Values",
     col = "lightblue",
     border = "black")
par(mfrow = c(1, 1))

#variables Age and ALB are quite symmetric, both are likely from normal distribution with some deviation in the tails

#variables TB, DB, Alkphos, Sgpt, Sgot and TP exhibit strong positive skewnwess

#variable AG_ratio exhibits mild positive skeweness
```

### 3.2 Bivariate Analysis

We now perform a bivariate analysis to understand the relationships between the candidate predictors and the response variable. We start from the `Gender` variable, which being categorical requires a different treatment from all the other ones, we analyze it using a contingency table and performing a chi-squared test.

```{r}
#Gender and Response
contingency_table <- table(data$Gender, data$Response)  
contingency_table
chi_squared_test <- chisq.test(contingency_table)
chi_squared_test

```

Using a significance level of 0.05 we fail to reject the null hypothesis, since the p-value is 0.05967 this means that, based on our data, there is not enough evidence to conclude that there is a significant association between gender and the diagnosis.

Next we proceed to analyze the other numerical variables, for each of them we provide a boxplot and a density plot, which are defined by two specific functions declared at the beginning of the script and used to create better visualizations. Again, we do not provide all of the plots but just some of them useful to understand the considerations provided in the comments.

```{r}
#Function for the boxplot
boxplot_response <- function(data, variable) {
  data_0 <- data[[variable]][data$Response == 0]
  data_1 <- data[[variable]][data$Response == 1]
  boxplot(data_0, data_1,
          main = paste(variable, "Boxplot"),
          ylab = variable,
          xlab = "Response",
          names = c("0", "1"),
          col = c("lightblue", "red"))
}

#Function for the density plot
density_response <- function(data, variable) {
  dens_0 <- density(data[[variable]][data$Response == 0])
  dens_1 <- density(data[[variable]][data$Response == 1])
  plot(dens_0, col = "lightblue", main = paste(variable, "Density Plot"), xlab = variable, ylab = "Density", lwd = 2)
  lines(dens_1, col = "red", lwd = 2)
  legend("topright", legend = c("0", "1"), fill = c("lightblue", "red"))
}

#Age and Response
par(mfrow = c(1, 2))
boxplot_response(data, "Age")
density_response(data, "Age")
#Age DOES NOT seem to be a good predictor of the response variable

#TB and Response
par(mfrow = c(1, 2))
boxplot_response(data, "TB")
density_response(data, "TB")
#TB seems to be a good predictor of the response variable

#DB and Response
par(mfrow = c(1, 2))
boxplot_response(data, "DB")
density_response(data, "DB")
#DB seems to be a good predictor of the response variable

#Alkphos and Response
par(mfrow = c(1, 2))
boxplot_response(data, "Alkphos")
density_response(data, "Alkphos")
#Alkphos seems to be a good predictor of the response variable

#Sgpt and Response
par(mfrow = c(1, 2))
boxplot_response(data, "Sgpt")
density_response(data, "Sgpt")
#Sgpt seems to be a good predictor of the response variable

#Sgot and Response
par(mfrow = c(1, 2))
boxplot_response(data, "Sgot")
density_response(data, "Sgot")
#Sgot seems to be a good predictor of the response variable

#TP and Response
par(mfrow = c(1, 2))
boxplot_response(data, "TP")
density_response(data, "TP")
#TP DOES NOT seem to be a good predictor of the response variable

#ALB and Response
par(mfrow = c(1, 2))
boxplot_response(data, "ALB")
density_response(data, "ALB")
#ALB DOES NOT seem to be a good predictor of the response variable

#AVG_ratio and Response
par(mfrow = c(1, 2))
boxplot_response(data, "AG_ratio")
density_response(data, "AG_ratio")
#AVG_ratio DOES NOT seem to be a good predictor of the response variable
```

### 3.3 Correlation Analysis

As a last step to our EDA, we perform a correlation analysis to understand the relationships between the numerical variables and to grasp which could be the variables characterized by a multicollinearity problem, thus we provide a correlation matrix.

```{r}
#Correlation
num_vars <- c_names[-c(2,11)]
cormat <- round(cor(data[,num_vars]),2)
corrplot(cormat, method = "number", type = "lower", 
         tl.col = "black", tl.srt = 45)

#TB and DB are highly correlated
#Sgpt and Sgot are highly correlated
#TP and ALB are highly correlated
#AVG_ratio and ALB are highly correlated
```

![](Correlations%20Plot.png)

Below we provide motivations for the high correlations found between some of the variables:

-   *TB and DB*: Total Bilirubin is the sum of Direct Bilirubin and Indirect Bilirubin, therefore it is expected that the total and the direct are strongly positively correlated. Furthermore, medical literature suggests that the direct bilirubin is a more specific indicator of liver disease than the total bilirubin, therefore it is possible for DB to be a better predictor of the response variable.

-   *Sgpt and Sgot*: Sgpt or ALT (Alanine Aminotransferase) and Sgot or AST (Aspartate Aminotransferase) are two enzymes that are found in the liver. They are often used together to diagnose liver disease, thus it is expected that they are highly correlated. However, Sgpt (ALT) is more specific to liver damage than Sgot (AST), therefore it is possible for Sgpt to be a better predictor of the response variable.

-   *TP and ALB*: Total Proteins in the blood are composed of Albumin and Globulins, therefore it is expected that the total and the albumin are strongly positively correlated. However, Albumin is the most abundant protein in the blood and is produced by the liver, therefore it is possible for ALB to be a better predictor of the response variable.

-   *ALB and AVG_ratio*: For the reasons outlined in the previous point, it is expected that Albumin and the A/G ratio are highly correlated. Again, since albumin is more liver specific, it is possible for ALB to be a better predictor of the response variable.

## 4. Data Modeling

## 5. Data Interpretation
